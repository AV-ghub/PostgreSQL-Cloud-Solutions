## Процесс
> То что выполняется в текущий момент и преобразует входящие данные в исходящие, совокупность кода и ресуросв.

Создается только путем копирования уже существующего процесса (fork).
Процесс клонируется полностью, и только после пересоздания в клонированном процесе происходит замещение исполняемого кода на новый.
Т.е. при запуске кода происходит следующая последовательность:
* fork второго дочернего процесса (потомок) из первичного (родитель)
* переписание (загрузка) кода в потомке (системный вызов **exec**)
* исполнние потомка
* завершение потомка (системный вызов **exit**) и возврат в родитель
* состояние **зомби** (не занимает ресурсов, просто строка с идентификатором в таблице процессов). Считается в общем количестве процессов и сказывается на ограничении количества процессов для пользователя. Большое количество говорит о том, что либо система не справляется с обработкой процессов, либо в родительском процессе баг. когда отсутствует вызов wait, считывающий коды возврата потомков. В случае бага единственный способ завершить зомби-процессы - отцепить их от родительского процесса (сделать сиротами) и прикрепить к процессу Init, после чего он считает код возврата и завершит процесс.
* считывание кода возврата (вызов **wait**) (считать код возврата может только тот процесс (родитель), который запустил второй процесс (потомка))
* уничтожение потомка (удаление из ОС)
* завершение или продолжение работы родителя

Все процессы имеют родителя. Исключение - два системных процесса.
PID - идентификатор процесса
PPID - идентификатор родительского прорцесса
Init - первичный процесс в пространстве пользователя (PID = 1, PPID = 0). Возникает из ядра ОС в момент ее старта.
Kthreadd - первичный процесс в пространстве ядра (PID = 2, PPID = 0)

Процесс - совокупность файлов и данных (все есть файл).
```
# все процессы создаются и хранят свои данные тут
/proc/<pid>
```
> Просмотреть процессы могут любые пользователи.
>
> Управлять тпроцессом может либо владелец, либо root.
>
> Сменить владельца процесса невозможно.

Владельцем процесса является тот кто является владельцем каталога /proc/<pid>.

## Демон
Сервис, не воспринимающий сигналы ввода от пользователя (не работающая с терминалом).
Воспринимает только спец сигналы ОС.

## Kill
```
kill <-signal> pid
```
<-signal> может определяться константами с префиксом SIG*, либо в числовом виде. Всего их 28.

Полезные варианты:
* SIGINT-2 - аналог Ctrl-C
* SIGTERM-15 - по умоляанию сингнал завершения kill
* SIGKILL-9 - безусловное завершение

## Top
s+кол-во сек - интервал обновления
1 - показываем имеющиеся ядра процессора и распределение нагрузки по ним (3 строка шапки)

### Информация в шапке
* uptime
* load average (min/5 min/15min) - кол-во процессов в очереди на ожидание ресурсов (нормальное значение должно быть меньше либо равно кол-ву ядер процессора). Однако в очередь встают не только процессы, ожидающие процессорного времени, но и ожидающие ресурсы **ввода-вывода**(напр сетевой ресурс и т.п.. такой процесс получает статус D и его нельзя завершить). Потому очередь может принимать астрономические значения в случае задержек на таких ресурсах, что не говорит о загруженности процессора.

### Строка CPU
* us - пространство пользователя
* sy - системное пространство (сетевые устройства, драйверы etc)
* ni - атавизм, доля процессов с пониженным приоритетом
* id - idle, процент простоя CPU
* wa - wait, сколько времени потрачено на общение с устройствами ввода-вывода (даже 5-10% будут очень существенноо влиять на производительносьть)
* hi - hardware interaption, сколько ресурсов потрачено на аппаратные прерывания (прицеплено какое-то странное или неправильно работающее устройство)
* si - sofware interaption, программные прерывания (это может быть какой-то софт, работающий в режиме раздачи разделенных ресурсов, напр торрент-клиент)
* st - stolen, сколько времени было заимствовано хостовой машиной (актуально не для всех гипервизоров. напр актуально для KVM, не еактуально для Hiper-V)

Маленький wa и большой load average - много процессов в статусе D.

Большой wa и большой load average - узкое место - устройства IO (сеть, диск).

Большой wa и маленький load average и idle близок к нулю и us+si в сумме дают почти 100% - проблема с производительностью процессора.

## Список процессов
### ps
```
e - все процессы в системе
f - full info about process
l - long

ps -efl | less
ps -efl | wc -l
ps -efl | head -1

[admin@igonin-vl share]$ ps -efl | grep 27112
0 S admin    27112  2536  0  80   0 - 29699 do_wai 09:07 pts/1    00:00:00 /bin/bash
0 R admin    27288 27112  0  80   0 - 38862 -      09:27 pts/1    00:00:00 ps -efl
0 S admin    27289 27112  0  80   0 - 28208 pipe_w 09:27 pts/1    00:00:00 grep --color=auto 27112
[admin@igonin-vl share]$ ps -efl | grep 2536
1 S admin     2536     1  0  80   0 - 169116 poll_s сен22 ?    00:14:39 kdeinit4: konsole [kdeinit] -session 1028c1d3
0 S admin     2555  2536  0  80   0 - 29698 do_wai сен22 pts/0 00:00:00 /bin/bash
0 S admin    27112  2536  0  80   0 - 29699 do_wai 09:07 pts/1    00:00:00 /bin/bash
0 S admin    27291 27112  0  80   0 - 28208 pipe_w 09:27 pts/1    00:00:00 grep --color=auto 2536

[admin@igonin-vl share]$ pstree
systemd─┬─ModemManager───2*[{ModemManager}]
        ├─NetworkManager─┬─dhclient
        │                └─2*[{NetworkManager}]
        ├─3*[VBoxClient───VBoxClient───2*[{VBoxClient}]]
        ├─VBoxClient───VBoxClient───3*[{VBoxClient}]
        ├─VBoxService───8*[{VBoxService}]
        ├─2*[abrt-watch-log]
        ├─abrtd
```

## Разбор процесса
Запуск любой команды - запуск отдельного процесса. При запуске конвейера из 5 команд получаем 5 процессов от данного пользователя (сервиса).

```
ls -l /proc/
ls -l /proc/ | wc -l

ps -efl | grep admin
0 S admin    24175  2555  0  80   0 - 40550 poll_s сен28 pts/0 00:09:06 top
0 S admin    27112  2536  0  80   0 - 29699 do_wai 09:07 pts/1    00:00:00 /bin/bash
1 S admin    27227  2345  1  80   0 - 161993 poll_s 09:11 ?       00:00:19 kdeinit4: dolphin [kdeinit] --icon system-fil
0 R admin    27315 27112  0  80   0 - 38862 -      09:35 pts/1    00:00:00 ps -efl
0 S admin    27316 27112  0  80   0 - 28209 pipe_w 09:35 pts/1    00:00:00 grep --color=auto admin

[admin@igonin-vl share]$ ls -ld /proc/27112
dr-xr-xr-x. 9 admin admin 0 сен 29 09:07 /proc/27112

```
### Сколько всего в системе файлов, где admin является владельцем
```
ls -ld /proc/27112/* | wc -l
49
[admin@igonin-vl share]$ ls -ld /proc/27112/* | grep admin
dr-xr-xr-x. 2 admin admin 0 сен 29 09:29 /proc/27112/attr
-rw-r--r--. 1 admin admin 0 сен 29 09:40 /proc/27112/autogroup
-r--------. 1 admin admin 0 сен 29 09:40 /proc/27112/auxv
-r--r--r--. 1 admin admin 0 сен 29 09:40 /proc/27112/cgroup
--w-------. 1 admin admin 0 сен 29 09:40 /proc/27112/clear_refs
-r--r--r--. 1 admin admin 0 сен 29 09:07 /proc/27112/cmdline
```
### Сколько всего в системе процессов, где admin является владельцем
```
[admin@igonin-vl share]$ ls -ld /proc/* | grep admin
dr-xr-xr-x.  9 root           admin                        0 сен 22 10:39 /proc/2154
dr-xr-xr-x.  9 admin          admin                        0 сен 22 10:39 /proc/2167
dr-xr-xr-x.  9 admin          admin                        0 сен 22 10:39 /proc/2176

[admin@igonin-vl share]$ ls -ld /proc/* | grep admin | wc -l
65
```

### Разбор процесса ssh
```
[admin@igonin-vl share]$ ps -efl | grep ssh
4 S root      1327     1  0  80   0 - 28250 poll_s сен22 ?     00:00:00 /usr/sbin/sshd -D
1 S admin     2287  2167  0  80   0 - 18142 poll_s сен22 ?     00:00:04 /usr/bin/ssh-agent /bin/sh -c exec -l /bin/bash -c "/usr/bin/startkde"
0 S admin    27371 27112  0  80   0 - 28209 pipe_w 09:52 pts/1    00:00:00 grep --color=auto ssh

man sshd
# search for conf param
/conf
-f config_file
             Specifies the name of the configuration file.  The default is /etc/ssh/sshd_config.  sshd refuses to start if there is no configuration file.

[admin@igonin-vl share]$ ls -l c
-rw-------. 1 root root 3907 авг  4 19:00 /etc/ssh/sshd_config

sudo less /etc/ssh/sshd_config

# считаем только примененные строки
sudo grep -v ^# /etc/ssh/sshd_config
# убираем пустые строки
# ^ - начало строки
# $ - конец строки
sudo grep -v ^# /etc/ssh/sshd_config | grep -v ^$
sudo grep -v ^# /etc/ssh/sshd_config | grep -v ^$ | less
sudo grep -v ^# /etc/ssh/sshd_config | grep -v ^$ | wc -l
sudo wc -l /etc/ssh/sshd_config

[admin@igonin-vl share]$ sudo wc -l /etc/ssh/*
   509 /etc/ssh/moduli
    68 /etc/ssh/ssh_config
   139 /etc/ssh/sshd_config
     5 /etc/ssh/ssh_host_ecdsa_key
     1 /etc/ssh/ssh_host_ecdsa_key.pub
     7 /etc/ssh/ssh_host_ed25519_key
     1 /etc/ssh/ssh_host_ed25519_key.pub
    27 /etc/ssh/ssh_host_rsa_key
     1 /etc/ssh/ssh_host_rsa_key.pub
   758 итого

```














