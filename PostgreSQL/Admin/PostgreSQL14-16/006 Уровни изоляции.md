## üîÑ **–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

### **1. –ß–µ—Ç—ã—Ä–µ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏ –≤ PostgreSQL**

#### **–ò–∑ –∫–Ω–∏–≥–∏:**
1. **Read Uncommitted** - –≤ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Read Committed
2. **Read Committed** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
3. **Repeatable Read**
4. **Serializable**

#### **–ê–Ω–æ–º–∞–ª–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è:**

| –£—Ä–æ–≤–µ–Ω—å | Dirty Read | Non-Repeatable Read | Phantom Read | Serialization Anomaly |
|---------|------------|---------------------|--------------|----------------------|
| **Read Uncommitted** | ‚ùå (–≤ PG –∫–∞–∫ RC) | ‚ùå | ‚ùå | ‚ùå |
| **Read Committed** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| **Repeatable Read** | ‚úÖ | ‚úÖ | ‚úÖ (–≤ PG –¥–∞) | ‚ùå |
| **Serializable** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

---

### **2. Read Committed (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)**

#### **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- **–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤–∏–¥–∏—Ç —Å–Ω–∏–º–æ–∫** –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
- **UPDATE/DELETE –≤–∏–¥—è—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é**
- **–ù–µ—Ç Dirty Read** (–Ω–µ–ª—å–∑—è —á–∏—Ç–∞—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

#### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:**
```sql
-- –°–µ—Å—Å–∏—è 1
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- 1000

-- –°–µ—Å—Å–∏—è 2
BEGIN;
UPDATE accounts SET balance = 900 WHERE id = 1;
COMMIT;  -- –ó–∞–∫–æ–º–º–∏—Ç–∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

-- –°–µ—Å—Å–∏—è 1 (–≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
SELECT balance FROM accounts WHERE id = 1;  -- –£–∂–µ 900!
-- Non-Repeatable Read –ø—Ä–æ–∏–∑–æ—à–µ–ª
COMMIT;
```

---

### **3. Repeatable Read**

#### **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- **–í—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Å–Ω–∏–º–æ–∫** –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç Non-Repeatable Reads**
- **–í PostgreSQL —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç Phantom Reads**

#### **–ü—Ä–∏–º–µ—Ä —Å –ø—Ä–æ–±–ª–µ–º–æ–π:**
```sql
-- –°–µ—Å—Å–∏—è 1 (Repeatable Read)
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM users WHERE active = true;  -- 100

-- –°–µ—Å—Å–∏—è 2 (–¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
INSERT INTO users (name, active) VALUES ('new_user', true);
COMMIT;

-- –°–µ—Å—Å–∏—è 1 (–≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
SELECT COUNT(*) FROM users WHERE active = true;  -- –í—Å–µ –µ—â–µ 100!
-- Phantom Read –ù–ï –ø—Ä–æ–∏–∑–æ—à–µ–ª (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö –°–£–ë–î)
COMMIT;
```

#### **–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ:**
```sql
-- –°–µ—Å—Å–∏—è 1
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM products WHERE id = 1;

-- –°–µ—Å—Å–∏—è 2
UPDATE products SET price = 200 WHERE id = 1;
COMMIT;

-- –°–µ—Å—Å–∏—è 1 (–ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å)
UPDATE products SET stock = stock - 1 WHERE id = 1;
-- –û–®–ò–ë–ö–ê: could not serialize access due to concurrent update
-- –ù—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å ROLLBACK –∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

---

### **4. Serializable**

#### **–°–∞–º—ã–π —Å—Ç—Ä–æ–≥–∏–π —É—Ä–æ–≤–µ–Ω—å:**
- **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç** –ø–æ–ª–Ω—É—é —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å
- **–ú–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–æ–≤** –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö
- **–¢—Ä–µ–±—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** –∫ –ø–æ–≤—Ç–æ—Ä—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### **–ü—Ä–∏–º–µ—Ä –∞–Ω–æ–º–∞–ª–∏–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
```sql
-- –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
CREATE TABLE balances (account_id INT PRIMARY KEY, balance INT);
INSERT INTO balances VALUES (1, 1000), (2, 1000);

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A (Serializable)
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT SUM(balance) FROM balances;  -- 2000

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B (Serializable)  
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM balances WHERE account_id = 1;  -- 1000
UPDATE balances SET balance = 1100 WHERE account_id = 1;
COMMIT;  -- –£—Å–ø–µ—à–Ω–æ

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
UPDATE balances SET balance = 900 WHERE account_id = 2;
-- –û–®–ò–ë–ö–ê: could not serialize access due to read/write dependencies among transactions
-- –û—Ç–∫–∞—Ç –∏ –ø–æ–≤—Ç–æ—Ä
```

---

### **5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

#### **–ö–æ–≥–¥–∞ –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

| –£—Ä–æ–≤–µ–Ω—å | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã |
|---------|-------------------|---------|
| **Read Committed** | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤ | –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –æ—Ç—á–µ—Ç—ã |
| **Repeatable Read** | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–¥–µ –≤–∞–∂–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è |
| **Serializable** | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ—Ç—Ä–∞—è–º | –ê—É–∫—Ü–∏–æ–Ω—ã, –±–∏—Ä–∂–µ–≤—ã–µ —Ç–æ—Ä–≥–∏ |

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω—è:**
```sql
-- –î–ª—è –≤—Å–µ–π —Å–µ—Å—Å–∏–∏
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;

-- –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
-- ... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
COMMIT;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
SHOW TRANSACTION ISOLATION LEVEL;
```

---

### **6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**

#### **–ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
```sql
-- –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT 
    pid,
    now() - xact_start as duration,
    isolation_level,
    query,
    wait_event_type,
    wait_event
FROM pg_stat_activity 
WHERE state = 'active'
AND now() - xact_start > interval '5 minutes'
ORDER BY duration DESC;

-- –û—Ç–∫–∞—Ç—ã –∏–∑-–∑–∞ –∏–∑–æ–ª—è—Ü–∏–∏
SELECT 
    datname,
    xact_commit,
    xact_rollback,
    round(100.0 * xact_rollback / (xact_commit + xact_rollback + 1), 2) as rollback_ratio
FROM pg_stat_database
WHERE xact_commit + xact_rollback > 0;
```

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤:**
```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –¥–æ–ª–≥–∏—Ö idle —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
SET idle_in_transaction_session_timeout = '5min';

-- –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
SET statement_timeout = '30s';

-- –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤—Å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
SET lock_timeout = '10s';
```

---

### **7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ**

#### **–ó–∞–¥–∞–Ω–∏–µ 1: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏**
```sql
-- 1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE isolation_test (
    id SERIAL PRIMARY KEY,
    value INT,
    updated_at TIMESTAMP DEFAULT now()
);
INSERT INTO isolation_test (value) VALUES (100), (200), (300);

-- 2. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –≤ –¥–≤—É—Ö —Å–µ—Å—Å–∏—è—Ö:
-- –°–µ—Å—Å–∏—è A: BEGIN; SELECT * FROM isolation_test;
-- –°–µ—Å—Å–∏—è B: UPDATE isolation_test SET value = value * 2;
-- –°–µ—Å—Å–∏—è A: SELECT * FROM isolation_test; (—á—Ç–æ –≤–∏–¥–Ω–æ?)

-- 3. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏
```

#### **–ó–∞–¥–∞–Ω–∏–µ 2: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ Repeatable Read**
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
-- –°–µ—Å—Å–∏—è 1 (RR): SELECT, –∑–∞—Ç–µ–º UPDATE
-- –°–µ—Å—Å–∏—è 2: UPDATE —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É SELECT –∏ UPDATE —Å–µ—Å—Å–∏–∏ 1
-- –ù–∞–±–ª—é–¥–∞–π—Ç–µ –æ—à–∏–±–∫—É —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
```

#### **–ó–∞–¥–∞–Ω–∏–µ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production**
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
CREATE VIEW transaction_monitor AS
SELECT 
    datname,
    COUNT(*) as active_transactions,
    COUNT(*) FILTER (WHERE isolation_level = 'read committed') as rc,
    COUNT(*) FILTER (WHERE isolation_level = 'repeatable read') as rr,
    COUNT(*) FILTER (WHERE isolation_level = 'serializable') as ser,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') as idle_in_xact,
    MAX(now() - xact_start) as max_transaction_age
FROM pg_stat_activity 
WHERE backend_type = 'client backend'
GROUP BY datname;
```

---

### **üéØ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è:**

1. **PostgreSQL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Read Uncommitted** –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
2. **Repeatable Read –≤ PostgreSQL —Å–∏–ª—å–Ω–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞** (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç Phantom Reads)
3. **Serializable —Ç—Ä–µ–±—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ retry –ª–æ–≥–∏–∫–µ**
4. **–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤ Read Committed –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–π snapshot**
5. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ RR/SERIALIZABLE –ø—Ä–∏–≤–æ–¥—è—Ç –∫ rollback**

---

## ‚ùì **–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º –∏–∑–æ–ª—è—Ü–∏–∏:**

1. –ü–æ—á–µ–º—É –≤ PostgreSQL Read Uncommitted —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Read Committed?
2. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ "could not serialize access" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏?
3. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Non-Repeatable Read –∏ Phantom Read?
4. –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SERIALIZABLE –≤–º–µ—Å—Ç–æ REPEATABLE READ?
5. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?

---

## üîí **–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ä–æ–≤–Ω—è–º –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

### **1. –ü–æ—á–µ–º—É –≤ PostgreSQL Read Uncommitted —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Read Committed?**
**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **MVCC (Multi-Version Concurrency Control)**, –≥–¥–µ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ **—Å–Ω–∏–º–∫–æ–º (snapshot)** –¥–∞–Ω–Ω—ã—Ö. –í —ç—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å "–≥—Ä—è–∑–Ω—ã–µ" (–Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ) –¥–∞–Ω–Ω—ã–µ.

```sql
-- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
-- –°–µ—Å—Å–∏—è 1:
BEGIN;
INSERT INTO test VALUES (1);
-- –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã

-- –°–µ—Å—Å–∏—è 2:
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SELECT * FROM test;  -- –ù–ï —É–≤–∏–¥–∏—Ç —Å—Ç—Ä–æ–∫—É —Å id=1!
-- PostgreSQL –≤–µ—Ä–Ω–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –Ω–µ "–≥—Ä—è–∑–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ
```

**–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- –í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–µ SQL READ UNCOMMITTED –ø–æ–∑–≤–æ–ª—è–µ—Ç "–≥—Ä—è–∑–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"
- –ù–æ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —ç—Ç–æ –ø–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ
- PostgreSQL –≤—ã–±—Ä–∞–ª –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: "–µ—Å–ª–∏ –Ω–µ–ª—å–∑—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å - –ª—É—á—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å"

**–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥:** –í PostgreSQL –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É READ UNCOMMITTED –∏ READ COMMITTED.

---

### **2. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ "could not serialize access" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏?**
**–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏:** REPEATABLE READ –∏–ª–∏ SERIALIZABLE —É—Ä–æ–≤–Ω—è—Ö –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ.

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ—à–µ–Ω–∏—è:**

#### **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: Retry –ª–æ–≥–∏–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**
```python
# –ü—Ä–∏–º–µ—Ä –Ω–∞ Python —Å psycopg2
import psycopg2
from psycopg2 import OperationalError
import time

def execute_with_retry(sql, max_retries=3):
    for attempt in range(max_retries):
        try:
            conn = psycopg2.connect("...")
            conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_SERIALIZABLE)
            cursor = conn.cursor()
            cursor.execute(sql)
            conn.commit()
            return cursor.fetchall() if cursor.description else None
        except OperationalError as e:
            if "could not serialize access" in str(e):
                conn.rollback()
                time.sleep(0.1 * (2 ** attempt))  # Exponential backoff
                continue
            else:
                raise
        finally:
            conn.close()
    raise Exception("Max retries exceeded")
```

#### **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å advisory locks –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π**
```sql
-- –í–º–µ—Å—Ç–æ SERIALIZABLE –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
BEGIN;
SELECT pg_advisory_xact_lock(123);  -- —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Ä–µ—Å—É—Ä—Å–∞
-- ... –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ...
COMMIT;
```

#### **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**
```sql
-- 1. –î–µ–ª–∞–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—á–µ
BEGIN;
-- —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
COMMIT;

-- 2. –ß–∏—Ç–∞–π—Ç–µ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
BEGIN;
-- –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—à–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- –ó–∞—Ç–µ–º —á–∏—Ç–∞–π—Ç–µ
SELECT balance FROM accounts WHERE id = 1;
COMMIT;

-- 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SELECT FOR UPDATE –¥–ª—è —è–≤–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
BEGIN;
SELECT * FROM products WHERE id = 1 FOR UPDATE;
-- –¥—Ä—É–≥–∏–µ —Å–µ—Å—Å–∏–∏ –±—É–¥—É—Ç –∂–¥–∞—Ç—å
COMMIT;
```

#### **–°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
```sql
-- –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç—ã –¥–ª—è serializable
SET max_pred_locks_per_transaction = 256;  -- –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 64
SET max_pred_locks_per_relation = 1024;

-- –£–≤–µ–ª–∏—á–∏—Ç—å work_mem –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫
SET work_mem = '16MB';
```

---

### **3. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Non-Repeatable Read –∏ Phantom Read?**

#### **Non-Repeatable Read (–ù–µ–ø–æ–≤—Ç–æ—Ä—è—é—â–µ–µ—Å—è —á—Ç–µ–Ω–∏–µ):**
```sql
-- –°–µ—Å—Å–∏—è 1
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- 1000

-- –°–µ—Å—Å–∏—è 2
UPDATE accounts SET balance = 900 WHERE id = 1;
COMMIT;

-- –°–µ—Å—Å–∏—è 1 (—Ç–∞ –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
SELECT balance FROM accounts WHERE id = 1;  -- 900!
-- –ó–Ω–∞—á–µ–Ω–∏–µ –ò–ó–ú–ï–ù–ò–õ–û–°–¨ –º–µ–∂–¥—É –¥–≤—É–º—è —á—Ç–µ–Ω–∏—è–º–∏
```

**–°—É—Ç—å:** –û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å—Ç—Ä–æ–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –º–µ–∂–¥—É —á—Ç–µ–Ω–∏—è–º–∏.

#### **Phantom Read (–§–∞–Ω—Ç–æ–º–Ω–æ–µ —á—Ç–µ–Ω–∏–µ):**
```sql
-- –°–µ—Å—Å–∏—è 1  
BEGIN;
SELECT COUNT(*) FROM orders WHERE status = 'pending';  -- 10

-- –°–µ—Å—Å–∏—è 2
INSERT INTO orders (status) VALUES ('pending');
COMMIT;

-- –°–µ—Å—Å–∏—è 1 (—Ç–∞ –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
SELECT COUNT(*) FROM orders WHERE status = 'pending';  -- 11!
-- –ü–æ—è–≤–∏–ª–∞—Å—å –ù–û–í–ê–Ø —Å—Ç—Ä–æ–∫–∞, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∞—è —É—Å–ª–æ–≤–∏—é
```

**–°—É—Ç—å:** –ü–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–µ —É—Å–ª–æ–≤–∏—é –∑–∞–ø—Ä–æ—Å–∞.

#### **–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –≤ PostgreSQL:**
- **Read Committed:** –¥–æ–ø—É—Å–∫–∞–µ—Ç –ò Non-Repeatable Read, –ò Phantom Read
- **Repeatable Read:** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –û–ë–ê (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ SQL!)
- **–í –¥—Ä—É–≥–∏—Ö –°–£–ë–î** Repeatable Read –¥–æ–ø—É—Å–∫–∞–µ—Ç Phantom Read

---

### **4. –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SERIALIZABLE –≤–º–µ—Å—Ç–æ REPEATABLE READ?**

#### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SERIALIZABLE –∫–æ–≥–¥–∞:**

1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**
   ```sql
   -- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏
   BEGIN ISOLATION LEVEL SERIALIZABLE;
   UPDATE accounts SET balance = balance - 100 WHERE id = 1;
   UPDATE accounts SET balance = balance + 100 WHERE id = 2;
   -- –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –æ–±—â–∞—è —Å—É–º–º–∞ –Ω–∞ —Å—á–µ—Ç–∞—Ö –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è
   COMMIT;
   ```

2. **–°–ª–æ–∂–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏**
   ```sql
   -- –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤
   BEGIN ISOLATION LEVEL SERIALIZABLE;
   SELECT COUNT(*) FROM reservations WHERE event_id = 1;
   -- –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–∞, —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é
   INSERT INTO reservations (event_id, user_id) VALUES (1, 123);
   COMMIT;
   ```

3. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö**

4. **–ö–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ retry –ª–æ–≥–∏–∫–µ**

#### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REPEATABLE READ –∫–æ–≥–¥–∞:**

1. **–ù—É–∂–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
   ```sql
   -- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
   BEGIN ISOLATION LEVEL REPEATABLE READ;
   SELECT * FROM daily_sales;  -- —Å–Ω–∏–º–æ–∫ A
   SELECT * FROM inventory;    -- —Ç–æ—Ç –∂–µ —Å–Ω–∏–º–æ–∫ A
   -- –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–¥—è—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   COMMIT;
   ```

2. **–û–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º read-only —Å —Ä–µ–¥–∫–∏–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏**

3. **–ö–æ–≥–¥–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã –∫ —á–∞—Å—Ç—ã–º retry –∏–∑-–∑–∞ serialization failures**

#### **–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | REPEATABLE READ | SERIALIZABLE |
|----------|-----------------|--------------|
| **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | –í —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | –ü–æ–ª–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | –í—ã—à–µ | –ù–∏–∂–µ (–±–æ–ª—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫) |
| **–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫** | –†–µ–∂–µ | –ß–∞—â–µ |
| **Retry –ª–æ–≥–∏–∫–∞** | –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–∞ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** | –§–∏–Ω–∞–Ω—Å—ã, –æ—Ç—á–µ—Ç—ã | –ê—É–∫—Ü–∏–æ–Ω—ã, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |

---

### **5. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?**

#### **–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DO –±–ª–æ–∫–æ–≤ –≤ PostgreSQL**
```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –≤–Ω—É—Ç—Ä–∏ –ë–î
DO $$
DECLARE
  retry_count INTEGER := 0;
  max_retries INTEGER := 5;
BEGIN
  WHILE retry_count < max_retries LOOP
    BEGIN
      -- –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
      INSERT INTO audit_log (message) VALUES ('Transaction attempt');
      -- –î—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...
      
      COMMIT;
      EXIT;  -- –£—Å–ø–µ—Ö, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
      
    EXCEPTION 
      WHEN serialization_failure THEN
        retry_count := retry_count + 1;
        RAISE NOTICE 'Serialization failure, retry %', retry_count;
        CONTINUE;
    END;
  END LOOP;
  
  IF retry_count = max_retries THEN
    RAISE EXCEPTION 'Max retries exceeded';
  END IF;
END $$;
```

#### **–í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ savepoints –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ rollback**
```sql
-- –ë–æ–ª–µ–µ –≥–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥
BEGIN ISOLATION LEVEL SERIALIZABLE;

SAVEPOINT start_tx;

LOOP
  BEGIN
    -- –û–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å
    UPDATE counters SET value = value + 1 WHERE name = 'visits';
    
    -- –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - —É—Å–ø–µ—Ö
    RELEASE SAVEPOINT start_tx;
    EXIT;
    
  EXCEPTION WHEN serialization_failure THEN
    -- –û—Ç–∫–∞—Ç –∫ savepoint, –Ω–æ –Ω–µ –≤—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    ROLLBACK TO SAVEPOINT start_tx;
    -- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É
    PERFORM pg_sleep(0.01 * (2 ^ retry_count));
    CONTINUE;
  END;
END LOOP;

COMMIT;
```

#### **–í–∞—Ä–∏–∞–Ω—Ç 3: –û–±–µ—Ä—Ç–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
```python
# –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å exponential backoff –∏ jitter
import random
import time
from contextlib import contextmanager

@contextmanager
def serializable_transaction(connection, max_retries=5):
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å retry"""
    retry_count = 0
    
    while retry_count < max_retries:
        try:
            # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            connection.set_isolation_level(ISOLATION_LEVEL_SERIALIZABLE)
            cursor = connection.cursor()
            
            yield cursor  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            
            # –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è - –∫–æ–º–º–∏—Ç–∏–º
            connection.commit()
            return
            
        except psycopg2.OperationalError as e:
            if "could not serialize access" not in str(e):
                raise  # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—à–µ
            
            # Serialization failure - –¥–µ–ª–∞–µ–º rollback –∏ retry
            connection.rollback()
            retry_count += 1
            
            # Exponential backoff with jitter
            base_delay = 0.1  # 100ms
            max_delay = 2.0   # 2 seconds
            delay = min(base_delay * (2 ** retry_count), max_delay)
            jitter = random.uniform(0, delay * 0.1)  # 10% jitter
            time.sleep(delay + jitter)
            
            continue
            
        except Exception:
            connection.rollback()
            raise
    
    raise Exception(f"Transaction failed after {max_retries} retries")

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
with serializable_transaction(conn) as cursor:
    cursor.execute("UPDATE accounts SET balance = balance - 100 WHERE id = 1")
    cursor.execute("UPDATE accounts SET balance = balance + 100 WHERE id = 2")
```

#### **–í–∞—Ä–∏–∞–Ω—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pgBouncer —Å transaction pooling**
```ini
# –í pgbouncer.ini
[databases]
mydb = host=localhost dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ù–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å —è–≤–Ω—ã–π retry –≤ –∫–æ–¥–µ
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

---

## üìä **–®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º –∏–∑–æ–ª—è—Ü–∏–∏**

| –£—Ä–æ–≤–µ–Ω—å | Dirty Read | Non-Repeatable | Phantom Read | Serializable Errors | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|---------|------------|----------------|--------------|---------------------|-------------------|
| **RC** | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| **RR** | ‚ùå | ‚ùå | ‚ùå | –ò–Ω–æ–≥–¥–∞ | –§–∏–Ω–∞–Ω—Å—ã, –æ—Ç—á–µ—Ç—ã |
| **SER** | ‚ùå | ‚ùå | ‚ùå | –ß–∞—Å—Ç–æ | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ |

---

## üèÅ **Race Conditions –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö**

### **–ß—Ç–æ —Ç–∞–∫–æ–µ Race Condition (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏)?**
**Race Condition** - —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö/–ø–æ—Ç–æ–∫–∞—Ö.

### **–ü—Ä–∏–º–µ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—ã—Ç–∞—é—Ç—Å—è –∫—É–ø–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A
BEGIN;
SELECT quantity FROM products WHERE id = 1;  -- –í–∏–¥–∏—Ç: 1
-- –†–µ—à–∞–µ—Ç –∫—É–ø–∏—Ç—å

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B (–≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è)
BEGIN;
SELECT quantity FROM products WHERE id = 1;  -- –¢–û–ñ–ï –≤–∏–¥–∏—Ç: 1
-- –¢–æ–∂–µ —Ä–µ—à–∞–µ—Ç –∫—É–ø–∏—Ç—å

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A
UPDATE products SET quantity = 0 WHERE id = 1;
COMMIT;  -- –£—Å–ø–µ—à–Ω–æ

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B  
UPDATE products SET quantity = 0 WHERE id = 1;
COMMIT;  -- –¢–æ–∂–µ —É—Å–ø–µ—à–Ω–æ!

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±–∞ –¥—É–º–∞—é—Ç, —á—Ç–æ –∫—É–ø–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä
-- quantity = 0, –Ω–æ –ø—Ä–æ–¥–∞–Ω–æ 2 –µ–¥–∏–Ω–∏—Ü—ã!
```

### **–ü–æ—á–µ–º—É —ç—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –æ–ø–∞—Å–Ω–æ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö?**
```sql
-- –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: 2 –∏–Ω—Å—Ç–∞–Ω—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è + 1 –ë–î

-- –ò–Ω—Å—Ç–∞–Ω—Å 1 (–≤ –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–µ A)
BEGIN;
SELECT * FROM inventory WHERE product_id = 123;

-- –ò–Ω—Å—Ç–∞–Ω—Å 2 (–≤ –¥–∞—Ç–∞—Ü–µ–Ω—Ç—Ä–µ B, –∑–∞–¥–µ—Ä–∂–∫–∞ —Å–µ—Ç–∏ 50ms)
BEGIN;
SELECT * FROM inventory WHERE product_id = 123;

-- –û–ë–ê –≤–∏–¥—è—Ç quantity = 1
-- –û–ë–ê —Ä–µ—à–∞—é—Ç –æ–±–Ω–æ–≤–∏—Ç—å
-- –ò–∑-–∑–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ —Å–µ—Ç–∏ COMMIT'—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ—á—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
-- Race condition!
```

### **–¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ race conditions:**

#### **1. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å/—Å—á—ë—Ç—á–∏–∫:**
```sql
-- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
SELECT MAX(order_id) + 1 FROM orders;  -- Race condition!

-- –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
SELECT nextval('orders_order_id_seq');
```

#### **2. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:**
```sql
-- –ü—Ä–æ–±–ª–µ–º–∞ –¥–≤–æ–π–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
BEGIN;
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
SELECT COUNT(*) FROM bookings 
WHERE room_id = 101 AND date = '2024-01-15';  -- 0

-- –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –¢–û–ñ–ï –≤–∏–¥–∏—Ç 0 –∏ —Å–æ–∑–¥–∞—ë—Ç –±—Ä–æ–Ω—å

INSERT INTO bookings (room_id, date, user_id) 
VALUES (101, '2024-01-15', 42);
COMMIT;
-- –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥–≤–µ –±—Ä–æ–Ω–∏!
```

#### **3. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```sql
-- –î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- 1000
-- –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Ç–æ–∂–µ —á–∏—Ç–∞–µ—Ç 1000

UPDATE accounts SET balance = 900 WHERE id = 1;  -- –û–±–∞ –¥–µ–ª–∞—é—Ç UPDATE
COMMIT;
-- –ë–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å 900 –≤–º–µ—Å—Ç–æ 800
```

### **–†–µ—à–µ–Ω–∏–µ race conditions –≤ PostgreSQL:**

#### **–†–µ—à–µ–Ω–∏–µ 1: SERIALIZABLE –∏–∑–æ–ª—è—Ü–∏—è**
```sql
BEGIN ISOLATION LEVEL SERIALIZABLE;
-- –û–ø–µ—Ä–∞—Ü–∏–∏
COMMIT;  -- –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ: rollback —Å –æ—à–∏–±–∫–æ–π
-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ retry
```

#### **–†–µ—à–µ–Ω–∏–µ 2: –Ø–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**
```sql
-- SELECT FOR UPDATE
BEGIN;
SELECT * FROM products WHERE id = 1 FOR UPDATE;  -- –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
-- –î—Ä—É–≥–∏–µ —Å–µ—Å—Å–∏–∏ –∂–¥—É—Ç
UPDATE products SET quantity = quantity - 1 WHERE id = 1;
COMMIT;
```

#### **–†–µ—à–µ–Ω–∏–µ 3: –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**
```sql
-- –ò—Å–ø–æ–ª—å–∑—É–µ–º version/timestamp
UPDATE products 
SET quantity = quantity - 1, 
    version = version + 1 
WHERE id = 1 AND version = :current_version;
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º rows_affected: –µ—Å–ª–∏ 0 - –∫—Ç–æ-—Ç–æ –æ–±–Ω–æ–≤–∏–ª —Ä–∞–Ω—å—à–µ
```

#### **–†–µ—à–µ–Ω–∏–µ 4: Advisory locks**
```sql
BEGIN;
SELECT pg_advisory_xact_lock(123456);  -- lock –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É ID
-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
COMMIT;  -- lock –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è
```

#### **–†–µ—à–µ–Ω–∏–µ 5: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SKIP LOCKED**
```sql
-- –î–ª—è –æ—á–µ—Ä–µ–¥–µ–π –∑–∞–¥–∞—á
BEGIN;
SELECT * FROM job_queue 
WHERE status = 'pending' 
ORDER BY priority 
FOR UPDATE SKIP LOCKED 
LIMIT 1;
-- –ë–µ—Ä—ë—Ç –ø–µ—Ä–≤—É—é –Ω–µ–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É
COMMIT;
```

---

## üîÑ **pgBouncer —Å transaction pooling - –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç**

### **–í–∞–∂–Ω–æ–µ —É—Ç–æ—á—á–µ–Ω–∏–µ:**
**pgBouncer –ù–ï —Ä–µ—à–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã serialization!** –û–Ω —Ä–µ—à–∞–µ—Ç –¥—Ä—É–≥—É—é –ø—Ä–æ–±–ª–µ–º—É - **–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL**.

### **–¢—Ä–∏ —Ä–µ–∂–∏–º–∞ pool_mode –≤ pgBouncer:**

#### **1. session (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)**
```ini
pool_mode = session
```
- **–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ –≤—Å—é —Å–µ—Å—Å–∏—é**
- PostgreSQL backend –∂–∏–≤—ë—Ç –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω
- **–ê–Ω–∞–ª–æ–≥–∏—è:** –ê—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –Ω–∞ –¥–æ–ª–≥–∏–π —Å—Ä–æ–∫

#### **2. transaction**
```ini
pool_mode = transaction
```
- **–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
- –ü–æ—Å–ª–µ COMMIT/ROLLBACK —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª
- **–ê–Ω–∞–ª–æ–≥–∏—è:** –¢–∞–∫—Å–∏ - –¥–æ–µ—Ö–∞–ª –¥–æ —Ü–µ–ª–∏, —Ç–∞–∫—Å–∏ —Å–≤–æ–±–æ–¥–Ω–æ

#### **3. statement**
```ini
pool_mode = statement
```
- **–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**
- –ê–≤—Ç–æ–∫–æ–º–º–∏—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
- **–ê–Ω–∞–ª–æ–≥–∏—è:** –ê–≤—Ç–æ–±—É—Å - –∑–∞—à–µ–ª-–≤—ã—à–µ–ª

### **–ö–∞–∫ transaction pooling –ø–æ–º–æ–≥–∞–µ—Ç —Å serialization errors?**

#### **–ë–µ–∑ pgBouncer:**
```python
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
try:
    cursor.execute("BEGIN ISOLATION LEVEL SERIALIZABLE")
    cursor.execute("... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...")
    cursor.execute("COMMIT")
except SerializationError:
    # –ù—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ?
    # –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è?
    # –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

#### **–° pgBouncer –≤ transaction mode:**
```python
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
for attempt in range(3):
    try:
        cursor.execute("BEGIN ISOLATION LEVEL SERIALIZABLE")
        cursor.execute("... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...")
        cursor.execute("COMMIT")
        break  # –£—Å–ø–µ—Ö
    except SerializationError:
        # pgBouncer –£–ñ–ï –≤–µ—Ä–Ω—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ø—É–ª
        # –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∏—Ç –°–í–ï–ñ–ï–ï —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        # –ù–∏—á–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!
        continue
```

### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:**

**–ë–µ–∑ transaction pooling:**
```
App ‚Üí PostgreSQL
‚Üë       ‚Üë
|       | –ë—ç–∫–µ–Ω–¥ #1 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –æ—à–∏–±–∫–æ–π
|       | –ù—É–∂–Ω–æ —è–≤–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–° transaction pooling:**
```
App ‚Üí pgBouncer ‚Üí PostgreSQL
     (–ø—É–ª)      (–±—ç–∫–µ–Ω–¥—ã)
     
1. App: BEGIN SERIALIZABLE ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –±—ç–∫–µ–Ω–¥ #1
2. –û—à–∏–±–∫–∞ serialization
3. App: –¥–µ–ª–∞–µ—Ç ROLLBACK
4. pgBouncer: —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±—ç–∫–µ–Ω–¥ #1 –≤ –ø—É–ª
5. App: –Ω–æ–≤—ã–π BEGIN ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –±—ç–∫–µ–Ω–¥ #2 (–∏–ª–∏ #1, –Ω–æ –æ—á–∏—â–µ–Ω–Ω—ã–π)
```

### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å serializable —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏:**
```ini
# pgbouncer.ini
[databases]
mydb = host=localhost port=5432 dbname=mydb

[pgbouncer]
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20

# –í–∞–∂–Ω–æ –¥–ª—è serializable!
server_reset_query = DISCARD ALL
# –ò–õ–ò –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ:
server_reset_query_always = 1

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—É–ª
server_reset_query = 
    RESET ALL;
    SET SESSION AUTHORIZATION DEFAULT;
    ROLLBACK;
    DISCARD ALL;
    UNLISTEN *;
    SELECT pg_advisory_unlock_all();
```

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ:**
```sql
-- –ö–ª–∏–µ–Ω—Ç
BEGIN ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM accounts WHERE id = 1;
-- –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- –û–®–ò–ë–ö–ê: could not serialize access due to concurrent update

-- pgBouncer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
-- 1. –î–µ–ª–∞–µ—Ç (–∏–ª–∏ –æ–∂–∏–¥–∞–µ—Ç) ROLLBACK –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
-- 2. –í—ã–ø–æ–ª–Ω—è–µ—Ç server_reset_query
-- 3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ø—É–ª
-- 4. –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç "—á–∏—Å—Ç–æ–µ" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
```

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è serializable —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**

1. **–ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å, –ø–æ–∫–∞ PostgreSQL –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
2. **–ò–∑–æ–ª—è—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π:** –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —á–∏—Å—Ç–æ–≥–æ —Å–µ–∞–Ω—Å–∞
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–æ–π:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. **–ë—ã—Å—Ç—Ä—ã–π retry:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è:**

#### **–ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç —Å transaction pooling:**
```sql
-- 1. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Å—Å–∏–∏)
CREATE TEMP TABLE temp_data (...);  -- –ü–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏!

-- 2. SET/RESET –¥–ª—è —Å–µ—Å—Å–∏–∏
SET work_mem = '64MB';  -- –°–±—Ä–æ—Å–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

-- 3. Prepared statements
PREPARE myplan AS SELECT * FROM users;  -- –ü–æ—Ç–µ—Ä—è–µ—Ç—Å—è

-- 4. LISTEN/NOTIFY
LISTEN channel_name;  -- –û—Ç–ø–∏—à–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

#### **–†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å session variables –∏–ª–∏ application-level –∫—ç—à**
```sql
-- –í–º–µ—Å—Ç–æ SET:
BEGIN;
SET LOCAL work_mem = '64MB';  -- LOCAL - —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
-- –æ–ø–µ—Ä–∞—Ü–∏–∏
COMMIT;

-- –í–º–µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:
CREATE UNLOGGED TABLE scratch_data (...);
TRUNCATE scratch_data AFTER USE;
```

### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo apt-get install pgbouncer

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
cat > /etc/pgbouncer/pgbouncer.ini << EOF
[databases]
mydb = host=localhost port=5432 dbname=mydb user=postgres

[pgbouncer]
listen_addr = *
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20
reserve_pool_size = 5
server_reset_query = DISCARD ALL
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60
verbose = 0
admin_users = postgres
EOF

# –§–∞–π–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
echo '"postgres" "md5–≤–∞—à_—Ö—ç—à"' > /etc/pgbouncer/userlist.txt
# –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö—ç—à: echo -n "passwordpostgres" | md5sum

# –ó–∞–ø—É—Å–∫
sudo systemctl start pgbouncer
```

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É–ª–∞:**
```sql
-- –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ pgBouncer (–ø–æ—Ä—Ç 6432)
psql -p 6432 -U postgres pgbouncer

-- –°–º–æ—Ç—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
SHOW pools;
SHOW lists;
SHOW stats;

-- –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ SHOW pools:
 database | user | cl_active | cl_waiting | sv_active | sv_idle | sv_used | sv_tested | sv_login | maxwait
----------+------+-----------+------------+-----------+---------+---------+-----------+----------+---------
 mydb     | app  | 10        | 0          | 8         | 12      | 0       | 0         | 0        | 0
```

### **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å transaction pooling:**

‚úÖ **–•–æ—Ä–æ—à–æ –¥–ª—è:**
- –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
- –°–∏—Å—Ç–µ–º —Å —á–∞—Å—Ç—ã–º–∏ serialization errors
- –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
- –°–∏—Å—Ç–µ–º, –≥–¥–µ –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

‚ùå **–ü–ª–æ—Ö–æ –¥–ª—è:**
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- –î–æ–ª–≥–∏—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–∏—Å—Ç–µ–º, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö LISTEN/NOTIFY
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å —Å–ª–æ–∂–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–µ—Å—Å–∏–∏

---

## üéØ **–ò—Ç–æ–≥ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É:**

**–ù–µ—Ç**, pgBouncer —Å `pool_mode = transaction` **–Ω–µ —Ä–µ—à–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**. 

**–ù–æ –æ–Ω –î–ï–õ–ê–ï–¢ RETRY –õ–ï–ì–ß–ï**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. –ü–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª
2. –°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç "—á–∏—Å—Ç–æ–µ" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
3. –ù–µ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –≤—Ä—É—á–Ω—É—é
4. –ú–æ–∂–Ω–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ retry

**–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –Ω—É–∂–Ω–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è:**
```python
# 1. pgBouncer –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
# 2. Serializable –∏–∑–æ–ª—è—Ü–∏—è –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏  
# 3. Retry –ª–æ–≥–∏–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
# 4. Exponential backoff –¥–ª—èÈÅøÂÖç overload
```
