## üîÑ **–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

### **1. –ß–µ—Ç—ã—Ä–µ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏ –≤ PostgreSQL**

#### **–ò–∑ –∫–Ω–∏–≥–∏:**
1. **Read Uncommitted** - –≤ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Read Committed
2. **Read Committed** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
3. **Repeatable Read**
4. **Serializable**

#### **–ê–Ω–æ–º–∞–ª–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è:**

| –£—Ä–æ–≤–µ–Ω—å | Dirty Read | Non-Repeatable Read | Phantom Read | Serialization Anomaly |
|---------|------------|---------------------|--------------|----------------------|
| **Read Uncommitted** | ‚ùå (–≤ PG –∫–∞–∫ RC) | ‚ùå | ‚ùå | ‚ùå |
| **Read Committed** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| **Repeatable Read** | ‚úÖ | ‚úÖ | ‚úÖ (–≤ PG –¥–∞) | ‚ùå |
| **Serializable** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

---

### **2. Read Committed (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)**

#### **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- **–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤–∏–¥–∏—Ç —Å–Ω–∏–º–æ–∫** –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
- **UPDATE/DELETE –≤–∏–¥—è—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é**
- **–ù–µ—Ç Dirty Read** (–Ω–µ–ª—å–∑—è —á–∏—Ç–∞—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

#### **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:**
```sql
-- –°–µ—Å—Å–∏—è 1
BEGIN;
SELECT balance FROM accounts WHERE id = 1;  -- 1000

-- –°–µ—Å—Å–∏—è 2
BEGIN;
UPDATE accounts SET balance = 900 WHERE id = 1;
COMMIT;  -- –ó–∞–∫–æ–º–º–∏—Ç–∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

-- –°–µ—Å—Å–∏—è 1 (–≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
SELECT balance FROM accounts WHERE id = 1;  -- –£–∂–µ 900!
-- Non-Repeatable Read –ø—Ä–æ–∏–∑–æ—à–µ–ª
COMMIT;
```

---

### **3. Repeatable Read**

#### **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- **–í—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Å–Ω–∏–º–æ–∫** –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç Non-Repeatable Reads**
- **–í PostgreSQL —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç Phantom Reads**

#### **–ü—Ä–∏–º–µ—Ä —Å –ø—Ä–æ–±–ª–µ–º–æ–π:**
```sql
-- –°–µ—Å—Å–∏—è 1 (Repeatable Read)
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT COUNT(*) FROM users WHERE active = true;  -- 100

-- –°–µ—Å—Å–∏—è 2 (–¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
INSERT INTO users (name, active) VALUES ('new_user', true);
COMMIT;

-- –°–µ—Å—Å–∏—è 1 (–≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
SELECT COUNT(*) FROM users WHERE active = true;  -- –í—Å–µ –µ—â–µ 100!
-- Phantom Read –ù–ï –ø—Ä–æ–∏–∑–æ—à–µ–ª (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö –°–£–ë–î)
COMMIT;
```

#### **–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ:**
```sql
-- –°–µ—Å—Å–∏—è 1
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM products WHERE id = 1;

-- –°–µ—Å—Å–∏—è 2
UPDATE products SET price = 200 WHERE id = 1;
COMMIT;

-- –°–µ—Å—Å–∏—è 1 (–ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å)
UPDATE products SET stock = stock - 1 WHERE id = 1;
-- –û–®–ò–ë–ö–ê: could not serialize access due to concurrent update
-- –ù—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å ROLLBACK –∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

---

### **4. Serializable**

#### **–°–∞–º—ã–π —Å—Ç—Ä–æ–≥–∏–π —É—Ä–æ–≤–µ–Ω—å:**
- **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç** –ø–æ–ª–Ω—É—é —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å
- **–ú–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–æ–≤** –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö
- **–¢—Ä–µ–±—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** –∫ –ø–æ–≤—Ç–æ—Ä—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### **–ü—Ä–∏–º–µ—Ä –∞–Ω–æ–º–∞–ª–∏–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
```sql
-- –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
CREATE TABLE balances (account_id INT PRIMARY KEY, balance INT);
INSERT INTO balances VALUES (1, 1000), (2, 1000);

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A (Serializable)
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT SUM(balance) FROM balances;  -- 2000

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B (Serializable)  
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT balance FROM balances WHERE account_id = 1;  -- 1000
UPDATE balances SET balance = 1100 WHERE account_id = 1;
COMMIT;  -- –£—Å–ø–µ—à–Ω–æ

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
UPDATE balances SET balance = 900 WHERE account_id = 2;
-- –û–®–ò–ë–ö–ê: could not serialize access due to read/write dependencies among transactions
-- –û—Ç–∫–∞—Ç –∏ –ø–æ–≤—Ç–æ—Ä
```

---

### **5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

#### **–ö–æ–≥–¥–∞ –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

| –£—Ä–æ–≤–µ–Ω—å | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –ü—Ä–∏–º–µ—Ä—ã |
|---------|-------------------|---------|
| **Read Committed** | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤ | –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –æ—Ç—á–µ—Ç—ã |
| **Repeatable Read** | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–¥–µ –≤–∞–∂–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è |
| **Serializable** | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ—Ç—Ä–∞—è–º | –ê—É–∫—Ü–∏–æ–Ω—ã, –±–∏—Ä–∂–µ–≤—ã–µ —Ç–æ—Ä–≥–∏ |

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω—è:**
```sql
-- –î–ª—è –≤—Å–µ–π —Å–µ—Å—Å–∏–∏
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;

-- –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
-- ... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
COMMIT;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
SHOW TRANSACTION ISOLATION LEVEL;
```

---

### **6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**

#### **–ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
```sql
-- –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT 
    pid,
    now() - xact_start as duration,
    isolation_level,
    query,
    wait_event_type,
    wait_event
FROM pg_stat_activity 
WHERE state = 'active'
AND now() - xact_start > interval '5 minutes'
ORDER BY duration DESC;

-- –û—Ç–∫–∞—Ç—ã –∏–∑-–∑–∞ –∏–∑–æ–ª—è—Ü–∏–∏
SELECT 
    datname,
    xact_commit,
    xact_rollback,
    round(100.0 * xact_rollback / (xact_commit + xact_rollback + 1), 2) as rollback_ratio
FROM pg_stat_database
WHERE xact_commit + xact_rollback > 0;
```

#### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤:**
```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –¥–æ–ª–≥–∏—Ö idle —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
SET idle_in_transaction_session_timeout = '5min';

-- –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
SET statement_timeout = '30s';

-- –¢–∞–π–º–∞—É—Ç –Ω–∞ –≤—Å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
SET lock_timeout = '10s';
```

---

### **7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ**

#### **–ó–∞–¥–∞–Ω–∏–µ 1: –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏**
```sql
-- 1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE isolation_test (
    id SERIAL PRIMARY KEY,
    value INT,
    updated_at TIMESTAMP DEFAULT now()
);
INSERT INTO isolation_test (value) VALUES (100), (200), (300);

-- 2. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –≤ –¥–≤—É—Ö —Å–µ—Å—Å–∏—è—Ö:
-- –°–µ—Å—Å–∏—è A: BEGIN; SELECT * FROM isolation_test;
-- –°–µ—Å—Å–∏—è B: UPDATE isolation_test SET value = value * 2;
-- –°–µ—Å—Å–∏—è A: SELECT * FROM isolation_test; (—á—Ç–æ –≤–∏–¥–Ω–æ?)

-- 3. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏
```

#### **–ó–∞–¥–∞–Ω–∏–µ 2: –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ Repeatable Read**
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
-- –°–µ—Å—Å–∏—è 1 (RR): SELECT, –∑–∞—Ç–µ–º UPDATE
-- –°–µ—Å—Å–∏—è 2: UPDATE —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É SELECT –∏ UPDATE —Å–µ—Å—Å–∏–∏ 1
-- –ù–∞–±–ª—é–¥–∞–π—Ç–µ –æ—à–∏–±–∫—É —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
```

#### **–ó–∞–¥–∞–Ω–∏–µ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production**
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
CREATE VIEW transaction_monitor AS
SELECT 
    datname,
    COUNT(*) as active_transactions,
    COUNT(*) FILTER (WHERE isolation_level = 'read committed') as rc,
    COUNT(*) FILTER (WHERE isolation_level = 'repeatable read') as rr,
    COUNT(*) FILTER (WHERE isolation_level = 'serializable') as ser,
    COUNT(*) FILTER (WHERE state = 'idle in transaction') as idle_in_xact,
    MAX(now() - xact_start) as max_transaction_age
FROM pg_stat_activity 
WHERE backend_type = 'client backend'
GROUP BY datname;
```

---

### **üéØ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã –¥–ª—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è:**

1. **PostgreSQL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Read Uncommitted** –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
2. **Repeatable Read –≤ PostgreSQL —Å–∏–ª—å–Ω–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞** (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç Phantom Reads)
3. **Serializable —Ç—Ä–µ–±—É–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ retry –ª–æ–≥–∏–∫–µ**
4. **–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤ Read Committed –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–π snapshot**
5. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ RR/SERIALIZABLE –ø—Ä–∏–≤–æ–¥—è—Ç –∫ rollback**

---

## ‚ùì **–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º –∏–∑–æ–ª—è—Ü–∏–∏:**

1. –ü–æ—á–µ–º—É –≤ PostgreSQL Read Uncommitted —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Read Committed?
2. –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ "could not serialize access" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏?
3. –í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Non-Repeatable Read –∏ Phantom Read?
4. –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SERIALIZABLE –≤–º–µ—Å—Ç–æ REPEATABLE READ?
5. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π?
